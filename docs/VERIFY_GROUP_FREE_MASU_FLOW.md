# 検証：グループ＋自由記載マスの「部屋→集める→入力→ビンゴ」フロー

**保管方針**  
このフルフロー（部屋作成→合言葉で集める→空白マスを参加者に割り当てて入力→集約してビンゴ生成）の実装は、**バトルビンゴを実装するとき以外は行わない**。本ドキュメントはその際の設計・検証の参照用として保管する。  
関連：`FEEDBACK_SPEC.md` の §13。

---

## 希望する流れ（整理）

| ステップ | 内容 |
|----------|------|
| 1. 部屋を作る | 合言葉を設定し、**空白マスが N 個あることだけ**を指定する（この時点では内容は空） |
| 2. 参加者を集める | 合言葉を共有し、参加者が「この部屋に参加」する |
| 3. 空白マスの内容を入力 | 参加者に**誰がどのマスを書くか**をランダムかつできるだけフェアに割り当て、各自が割り当てられたマスにだけ入力する |
| 4. ビンゴが作られる | 全員分の入力が揃ったら（または条件を満たしたら）、その N 個の内容でビンゴが生成される |

これと**現状**の違い：

- **現状**: 部屋を作る人だけが空白マスの内容を入力 → 合言葉で人を集める → 参加者は「作った人から教えてもらったお題」を手動で入力するしかない（空白マス内容の共有がアプリ内で完結しない）。
- **希望**: 部屋＝「合言葉＋空白マス数 N」だけが先に決まり、**参加者が N 個のマスに誰が何を書くかを割り当てて入力** → その結果を集約してからビンゴ生成。

---

## 結論：実装可能か

- **現在の構成（フロントのみ・LocalStorage のみ）では、この希望フローは実装できません。**
- **バックエンド（またはそれに類する「みんなで見る共通の部屋状態」）を用意すれば、実装可能です。**

---

## 理由（現状でできない点）

1. **「部屋」が端末ごとに存在しない**  
   合言葉は各端末でローカルに持っているだけで、「この合言葉の部屋」という共通の状態がどこにもない。誰が参加しているか・何人目か・誰がどのマスを担当するかは、集約する場所がないと決められない。

2. **「誰がどのマスを書くか」の割り当てができない**  
   ランダムかつフェアに割り当てるには、**参加者一覧**が確定している必要がある。参加者一覧は「部屋に参加した人」のリストなので、部屋状態が共有されていないと一覧が作れない。

3. **参加者ごとの入力内容を集められない**  
   N 個の空白マスに対する「みんなの入力」を1か所に集める必要がある。今は各端末の LocalStorage しかないため、他者の入力を受け取る手段がない。

4. **「入力が揃ったらビンゴを作る」が判定できない**  
   「全員分の入力が揃った」かどうかは、集約した結果を見ないと分からない。集約する仕組みがなければ、タイミングの判定もできない。

したがって、**「部屋を作る → 合言葉で集める → 空白マスを参加者に割り当てて入力 → 集約してビンゴ生成」**という流れを実現するには、**部屋の状態と参加者・割り当て・入力内容を保持する「共通の場所」（＝バックエンド相当）が必須**です。

---

## 実装可能にするために必要なもの

### 必要になる機能のイメージ

| 機能 | 説明 |
|------|------|
| 部屋の永続化 | 合言葉（＋空白マス数 N など）をキーにした「部屋」をサーバー（または Firebase 等）に作成・保存する |
| 参加の登録 | 参加者が合言葉で部屋を検索し、「参加」すると部屋の参加者一覧に追加される（参加順や ID で「誰が何人目か」が分かる） |
| 割り当ての決定 | 参加者が揃った時点（または「割り当て確定」ボタンなど）で、N 個のマスに参加者をランダム・フェアに割り当て（例：1人1マス、または余りは重複で担当）、その割り当てを部屋に保存する |
| 入力の送信・集約 | 各参加者が「自分が担当するマス」にだけ入力し、その内容を部屋に送信。部屋側で N 個分が揃うまで保持する |
| ビンゴ生成のトリガー | N 個すべて入力が揃ったら（または主催者が「開始」したら）、部屋に保存されている N 個の文字列を「この部屋の自由記載お題リスト」として確定し、各クライアントがそのリスト＋合言葉＋userId でビンゴを生成する |

### 技術的な選択肢（いずれかが必要）

- **自前バックエンド**  
  Node/Express 等で「部屋」用の API（作成・参加・割り当て取得・入力送信・入力一覧取得）を用意し、フロントから呼ぶ。
- **BaaS（Firebase / Supabase 等）**  
  「部屋」をドキュメントまたはテーブルで持ち、参加者・割り当て・各マスの入力内容を同じ場所に書き込む。クライアントはそのデータを購読して「揃ったか」を判定し、揃ったらビンゴ生成に使う。
- **その他**  
  同じ「部屋状態」を共有できる仕組み（例：簡易 WebSocket サーバー＋DB）があれば同様の流れは実現可能。

---

## 割り当てを「ランダムかつフェア」にする例

- **参加者 P 人、空白マス N 個**
  - N ≧ P のとき：1人あたり 1 マス以上。余ったマスはランダムに誰かに追加で 1 マスずつ割り当て（またはくじで担当者を決める）でフェアに。
  - N < P のとき：N 人に 1 マスずつ割り当て、残り (P−N) 人は「担当なし」（見るだけ／ビンゴには参加するが入力はしない）とする、などルールを決める。

割り当て結果は「マス index → 担当者のユーザーID（または参加順）」を部屋に保存し、各クライアントは「自分の担当マス」だけ入力欄を表示し、送信時に「部屋ID＋マス index＋内容」を送る形にするとよい。

---

## まとめ

| 質問 | 回答 |
|------|------|
| 希望フロー（部屋作成→合言葉で集める→空白マスを参加者で入力→ビンゴ生成）は実装可能か？ | **バックエンド（または部屋状態を共有する仕組み）を用意すれば可能。** |
| 現状のフロント＋LocalStorage のみでは？ | **不可。部屋・参加者・割り当て・入力の集約を共通で持つ場所がないため。** |
| 実装するなら何が必要か？ | 部屋の作成・参加・割り当て決定・入力の送信と集約・「揃ったらビンゴ」の判定ができるバックエンド（または BaaS）が必要。 |

この検証結果を踏まえ、バックエンドを新規に作るか BaaS を導入するか決めれば、上記フローに沿った詳細仕様・API 設計に落とし込めます。
