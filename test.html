<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>お散歩ビンゴ - テストページ</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
        }
        .test-section {
            border: 2px solid #ddd;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 10px;
        }
        .test-result {
            margin: 10px 0;
            padding: 10px;
            border-radius: 5px;
        }
        .test-pass {
            background: #d4edda;
            color: #155724;
        }
        .test-fail {
            background: #f8d7da;
            color: #721c24;
        }
        button {
            padding: 10px 20px;
            margin: 5px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <h1>お散歩ビンゴ - 基本機能テスト</h1>
    
    <div class="test-section">
        <h2>1. DOM要素の確認</h2>
        <button onclick="testDOMElements()">テスト実行</button>
        <div id="dom-test-results"></div>
    </div>
    
    <div class="test-section">
        <h2>2. LocalStorage テスト</h2>
        <button onclick="testLocalStorage()">テスト実行</button>
        <div id="storage-test-results"></div>
    </div>
    
    <div class="test-section">
        <h2>3. ゲームロジック テスト</h2>
        <button onclick="testGameLogic()">テスト実行</button>
        <div id="logic-test-results"></div>
    </div>
    
    <div class="test-section">
        <h2>4. 実際のアプリを開く</h2>
        <button onclick="window.open('index.html', '_blank')">アプリを開く</button>
        <p>※ 新しいタブでアプリが開きます</p>
    </div>

    <script>
        function showResult(containerId, message, success) {
            const container = document.getElementById(containerId);
            const div = document.createElement('div');
            div.className = success ? 'test-result test-pass' : 'test-result test-fail';
            div.textContent = success ? '✓ ' + message : '✗ ' + message;
            container.appendChild(div);
        }

        function testDOMElements() {
            const container = document.getElementById('dom-test-results');
            container.innerHTML = '';
            
            fetch('index.html')
                .then(response => response.text())
                .then(html => {
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(html, 'text/html');
                    
                    const requiredElements = [
                        'bingoBoard',
                        'statsDisplay',
                        'resetBtn',
                        'newGameBtn',
                        'roomCodeModal',
                        'startGameBtn',
                        'photoModal',
                        'photoPromptModal',
                        'customTopicModal'
                    ];
                    
                    requiredElements.forEach(id => {
                        const element = doc.getElementById(id);
                        showResult('dom-test-results', 
                            `要素 #${id}`, 
                            element !== null);
                    });
                });
        }

        function testLocalStorage() {
            const container = document.getElementById('storage-test-results');
            container.innerHTML = '';
            
            try {
                // LocalStorageが使えるかテスト
                localStorage.setItem('test', 'value');
                const value = localStorage.getItem('test');
                localStorage.removeItem('test');
                showResult('storage-test-results', 
                    'LocalStorage 読み書きテスト', 
                    value === 'value');
                
                // 保存データの確認
                const saved = localStorage.getItem('osanpoBingo');
                if (saved) {
                    const data = JSON.parse(saved);
                    showResult('storage-test-results', 
                        `保存データあり (board: ${data.board?.length || 0}マス)`, 
                        true);
                } else {
                    showResult('storage-test-results', 
                        '保存データなし（初回起動）', 
                        true);
                }
            } catch (e) {
                showResult('storage-test-results', 
                    'LocalStorageエラー: ' + e.message, 
                    false);
            }
        }

        function testGameLogic() {
            const container = document.getElementById('logic-test-results');
            container.innerHTML = '';
            
            // app.jsを読み込んでテスト
            fetch('app.js')
                .then(response => response.text())
                .then(code => {
                    // 関数の存在確認
                    const hasFunctions = [
                        'seededRandom',
                        'shuffleWithSeed',
                        'stringToSeed',
                        'getUserId',
                        'OsanpoBingo'
                    ];
                    
                    hasFunctions.forEach(funcName => {
                        const exists = code.includes(`function ${funcName}`) || 
                                     code.includes(`const ${funcName}`) ||
                                     code.includes(`class ${funcName}`);
                        showResult('logic-test-results', 
                            `関数/クラス ${funcName}`, 
                            exists);
                    });
                    
                    // DOMContentLoadedの重複チェック
                    const matches = code.match(/document\.addEventListener\('DOMContentLoaded'/g);
                    showResult('logic-test-results', 
                        `DOMContentLoaded登録数: ${matches?.length || 0}`, 
                        matches?.length === 1);
                });
        }

        // ページ読み込み時に自動実行
        window.onload = () => {
            console.log('テストページ読み込み完了');
        };
    </script>
</body>
</html>
